{
  "name": "multi_scale_detection",
  "version": "1.0",
  "templates": {
    "EXPLICIT_MULTI_SCALE": {
      "description": "Prompt for multi-scale table detection with explicit compression information",
      "template": "You are analyzing spreadsheet visualizations at multiple scales to detect precise table boundaries.\n\nCRITICAL COMPRESSION INFORMATION:\n{compression_info}\n\nIMPORTANT:\n- Overview images show overall structure but NOT exact cell boundaries\n- Detail images (1:1 scale) show EXACT cell-level boundaries\n- Use overview for understanding layout, then detail images for precise coordinates\n\n{definitions}\n\nYOUR TASK:\n1. First, examine the overview image to understand the overall spreadsheet layout\n2. Identify potential table regions based on visual patterns\n3. For each potential table, examine the corresponding detail image\n4. Use the detail image to determine EXACT cell boundaries\n5. Consider the context area around each table (shown in yellow)\n\n{context_info}\n\nOUTPUT REQUIREMENTS:\n{output_schema}\n\nRemember: Only detail images (1:1 scale) show exact boundaries. Overview images are compressed.",
      "variables": [
        "compression_info",
        "definitions",
        "context_info",
        "output_schema"
      ]
    },

    "SINGLE_IMAGE": {
      "description": "Prompt for single image table detection (no compression)",
      "template": "Analyze this spreadsheet image to identify all tables and their exact boundaries.\n\nThis image has NO compression - each pixel represents exactly one cell.\n\n{definitions}\n\nYOUR TASK:\n1. Identify all distinct tables in the spreadsheet\n2. Determine exact cell boundaries for each table\n3. Look for natural breaks between tables (empty rows/columns)\n4. Consider headers, formatting, and data patterns\n\n{output_schema}",
      "variables": [
        "definitions",
        "output_schema"
      ]
    },

    "PROGRESSIVE_REFINEMENT": {
      "description": "Prompt for progressive refinement of large sheets",
      "template": "You are analyzing a very large spreadsheet using progressive refinement.\n\nCURRENT PHASE: {phase_name} (Phase {phase_number} of 3)\n\nPHASE OBJECTIVES:\n{phase_objectives}\n\nIMAGE INFORMATION:\n{compression_info}\n\n{definitions}\n\nPREVIOUS RESULTS:\n{previous_results}\n\nYOUR TASK:\n{phase_specific_task}\n\n{output_schema}",
      "variables": [
        "phase_name",
        "phase_number",
        "phase_objectives",
        "compression_info",
        "definitions",
        "previous_results",
        "phase_specific_task",
        "output_schema"
      ]
    },

    "MULTI_TABLE_DETECTION": {
      "description": "Prompt specifically for sheets with multiple tables",
      "template": "You are analyzing a spreadsheet that likely contains MULTIPLE distinct tables.\n\n{compression_info}\n\nKEY OBJECTIVES:\n1. Identify ALL separate tables (do not merge distinct tables)\n2. Look for clear separators:\n   - Empty rows/columns between tables\n   - Different formatting styles\n   - Distinct headers\n   - Change in data patterns\n\n{definitions}\n\nCONTEXT:\nThis spreadsheet contains {expected_table_count} or more tables based on initial analysis.\n\nFor each table found:\n- Verify it's truly separate (not a continuation)\n- Check boundaries carefully using detail images\n- Note any relationships between tables\n\n{output_schema}",
      "variables": [
        "compression_info",
        "definitions",
        "expected_table_count",
        "output_schema"
      ]
    },

    "REFINEMENT_WITH_FEEDBACK": {
      "description": "Prompt for refining detection based on verification feedback",
      "template": "Previous table detection needs refinement based on verification results.\n\nVERIFICATION FEEDBACK:\n{feedback}\n\nORIGINAL PROPOSALS:\n{original_proposals}\n\nISSUES TO ADDRESS:\n{issues}\n\n{definitions}\n\nREFINEMENT TASK:\n1. Re-examine the highlighted problem areas\n2. Pay special attention to:\n   {focus_areas}\n3. Use the detail images to verify exact boundaries\n4. Consider the suggested adjustments\n\n{output_schema}",
      "variables": [
        "feedback",
        "original_proposals",
        "issues",
        "definitions",
        "focus_areas",
        "output_schema"
      ]
    }
  },

  "definitions": {
    "rectangularness": "The ratio of filled cells to total cells in the bounding box (0.0-1.0). A value of 1.0 means a perfectly filled rectangle with no gaps.",
    "consistency": "The degree to which cells in the same column contain the same type of data (text, numbers, dates).",
    "alignment": "Whether cells form straight edges without scattered data outside the main rectangular block.",
    "table": "A cohesive rectangular region containing related data, typically with headers in the first row(s) and consistent column structure.",
    "natural_break": "Empty rows/columns, significant formatting changes, or clear visual separation indicating table boundaries.",
    "context_area": "The cells surrounding a proposed table boundary (highlighted in yellow) that help verify the boundary is correct.",
    "confidence": "How certain the detection is (0.0-1.0), based on visual clarity, data patterns, and boundary definition."
  },

  "output_schemas": {
    "standard": {
      "type": "object",
      "properties": {
        "tables": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "bounds", "confidence"],
            "properties": {
              "id": {"type": "string", "description": "Unique identifier like 'table_1'"},
              "bounds": {
                "type": "object",
                "required": ["top_row", "left_col", "bottom_row", "right_col"],
                "properties": {
                  "top_row": {"type": "integer", "description": "Top row index (0-based)"},
                  "left_col": {"type": "integer", "description": "Left column index (0-based)"},
                  "bottom_row": {"type": "integer", "description": "Bottom row index (inclusive)"},
                  "right_col": {"type": "integer", "description": "Right column index (inclusive)"}
                }
              },
              "confidence": {"type": "number", "minimum": 0, "maximum": 1},
              "evidence": {
                "type": "object",
                "properties": {
                  "rectangularness": {"type": "number"},
                  "has_headers": {"type": "boolean"},
                  "natural_break_after": {"type": "boolean"},
                  "context_cells_empty": {"type": "boolean"}
                }
              },
              "context_analysis": {
                "type": "object",
                "properties": {
                  "cells_before_top": {"type": "string"},
                  "cells_after_bottom": {"type": "string"},
                  "cells_left_of_bounds": {"type": "string"},
                  "cells_right_of_bounds": {"type": "string"}
                }
              },
              "description": {"type": "string", "description": "Brief description of table content"}
            }
          }
        },
        "analysis_notes": {"type": "string", "description": "Overall observations about the spreadsheet"}
      }
    },

    "progressive": {
      "type": "object",
      "properties": {
        "phase": {"type": "string"},
        "regions_identified": {"type": "array"},
        "refinements_needed": {"type": "array"},
        "confidence": {"type": "number"},
        "continue_refinement": {"type": "boolean"}
      }
    }
  }
}
